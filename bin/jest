#!/usr/bin/env julia

@require ".." suite test reporter @test @test_throws
@require "docopt/src/DocOpt" docopt
@require "emitter" Events on emit

const usage = """

Usage:
  jest [--reporter=<name>] <file>...
  jest -h | --help
  jest -v | --version

Options:
  -h --help     Show this screen
  -v --version  Show version
  -r --reporter Select a custom reporter

"""

args = docopt(usage, version="0.0.0")


if args["--reporter"] == nothing
  args["--reporter"] = "dot"
end

handlers = args["--reporter"]
handlers = Requirer.require("../reporters/$handlers").reporter

on(reporter, handlers)

fails = 0

on(reporter, "after test") do result
  global fails += !result.pass
end

emit(reporter, "before all")

try
  for file in args["<file>"]
    file = joinpath(pwd(), file)
    Requirer.require(file; [
      symbol("@test_throws") => eval(symbol("@test_throws")),
      symbol("@test") => eval(symbol("@test")),
      :suite => suite,
      :test => test
    ]...)
  end
  emit(reporter, "after all")
catch e
  emit(reporter, "error", e)
  rethrow(e)
end

# exit with correct error code
exit(fails)
